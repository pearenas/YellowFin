# -------------------------------------------------------------
#YellowFin.R
#
#Objetivo: Simulación que muestra como cambia el promedio de captura por barco de YellowFin conforme incrementa el
#porcentaje del área total cerrada a la pesca. 
#
#Escrito por: Pablo Esteban Arenas
#Octubre 2017
#
# -------------------------------------------------------------

#Cuando está leyendo esto por primera vez, quitar símbolo "###" de las filas 18-23 de abajo. Seleccionar las filas
#18-23 y presione el botón "Run" en la parte superior derecha de esta ventana. Espere unos segundos a que todo 
#termine de descargarse. Aparecerá una ventana y tendrá que escoger un archivo. Escoja el archivo "YellowFin.R"
#dentro de la carpeta descargada con este proyecto. Cuando termine vuelva a agregar los símbolos "###" en las líneas
#18-23.

###install.packages("ggplot2")
###filename = "YellowFin.R"
###filepath = file.choose()  # En la ventana escoja el archivo "YellowFin.R"
###dir = substr(filepath, 1, nchar(filepath)-nchar(filename))
###setwd(dir)
###OriginalWD <- getwd()

#NO OLVIDE DE VOLVER A AGREGAR LOS SIMBOLOS "###" A LAS LINEAS 18-23
# -------------------------------------------------------------

#Instrucciones para correr la simulación: Escriba cantidades deseadas en las variables abajo. Se recomienda escoger
#un área de mar que sea 10x10 con correspondiente incremento de porcentaje de .1. O escoger área de mar 100x100
#con correspondiente incremento de porcentaje de .01 Acuérdese de escoger las otras variables adecuadamente. Un mar
#de 10x10 o 100x100 tendrá 100 o 10,000 cuadros respectivamente. Cada barco y pez se puede pensar que ocupa un cuadro
#cada uno. Seleccione todo el código en esta pestaña con command+a o alt+a y presione "Run" en la parte superior 
#derecha de esta ventana. Para ver las gráficas generadas, en la parte inferior derecha, haga click and la pestaña 
#"Plots" si es que aún no está seleccionada. Después busque dentro de la carpeta descargada para este proyecto y 
#vera carpetas generadas que corresponden a las dimensiones del mar seleccionadas. Dentro se guardó los datos y 
#grafica generada. El nombre de los archivos corresponde a los números seleccionados para cada una de las variables 
#de abajo.

#Cómo funciona la simulación: Iniciamos con 0% de área abierta para la pesca. Ya al final se resta 
#1- (%de área abierta) para conseguir % de área cerrada a la pesca. Finalmente, el % de área cerrada a la pesca 
#es el eje x de las gráficas. Cada barco pesca una vez por día, el número de días en la temporada de pesca. 
#La captura de cada barco en cada día se va sumando. La temporada de pesca se repite el numero indicado de 
#repeticiones. Las capturas de los barcos se continúan sumando. Cuando las repeticiones llegan al # indicado, 
#se anota promedio de captura asociado con % de área abierta. Se agrega % de área abierta indicado y se repite 
#la simulación, ahora con el nuevo % de área abierta. La simulación termina cuando el % de área abierta a la pesca 
#es > 100%. Los peces restantes se distribuyen aleatoriamente cada día y se vuelven a su cantidad inicial en cada 
#nuevo % de área abierta. Los barcos de distribuyen aleatoriamente inicialmente y después se mueven cada día de su 
#posición antigua en dirección x y y (como un caballo de ajedrez), una cantidad aleatoria dentro del movimiento 
#máximo escogido. Los barcos pueden ocupar el mismo espacio. El primer barco en llegar a una coordenada pesca 
#todos los peces en esa coordenada.

#Escoja las variables debajo de aquí --------------------------------------------

#Dias de la temporada de Pesca
TemporadaDePescaDias <- 15
#Numero de Repeticiones de la Simulacion
Repeticiones <- 2
#Area del mar (x*x matriz)
MarDimension <- 10
#Numero de Peces
NumeroDePeces <- 300
#Numero de Barcos
NumeroDeBarcos <- 40
#Incremento de Porcentaje de Área de Mar Abierta
#Nota: Porcentaje se va acumulando y cada vez multiplica por la dimensión del mar, para generar nueva x*x
#matriz de área abierta a la pesca. Si la longitud de la nueva matriz es menor a número "3" y mayor a número "2", 
#se redondea a número "2"
IncrementoPorcentaje <- .1
#Cuantos cuadros maximo se pueden mover los barcos (direccion x - direccion y)
BarcoMovimiento <- 4


##############################
library(ggplot2) # For the plots
#Porcentaje de Area Abierta
AreaAbierta <- 0
i <- 1
BarcoCapturaPromedio <- vector()
DatosFinales <- data.frame (AreaAbierta = integer(),CapturaPromedio = integer())

while (i <= Repeticiones) {
  #Tamño del mar y espacio donde se distribuyen los peces
  mar <- matrix(0, nrow =MarDimension, ncol = MarDimension)
  #Dimensiones del area restringida a la pesca
  PorcentajeAreaAbierta <- as.numeric(as.character(AreaAbierta %*% nrow(mar)))
  AreaRestringidaDePesca <- matrix(0, nrow =PorcentajeAreaAbierta, ncol = PorcentajeAreaAbierta)
  #Coordenadas de los Barcos
  if (nrow(AreaRestringidaDePesca) == 0){
    tmp <- data.frame(AreaCerrada = 0,CapturaPromedio = 0)
    DatosFinales <- rbind(DatosFinales,tmp)
    AreaAbierta <- AreaAbierta + IncrementoPorcentaje
    next
  } else {
    #Generar Numeros Aleatorios Para Coordenadas de Barcos
    BarcosX <- floor(runif(NumeroDeBarcos, min=1, max = nrow(AreaRestringidaDePesca)+1))
    BarcosY <- floor(runif(NumeroDeBarcos, min=1, max = nrow(AreaRestringidaDePesca)+1))
    #Generar Data Frame Para Coordenadas de Barcos
    Barcos <- as.data.frame(BarcosX)
    Barcos$BarcosY <- BarcosY
  }
  
  #Poner los barcos en su area restringida
  for (barco in 1:nrow(Barcos)) {
    row = Barcos[barco,]
    columna = row$BarcosX
    fila = row$BarcosY
    #Codigo para que los barcos no puedan estar en las mismas coordenadas, si el %de area abierta es mayor a 40%
    #    repeat{
    #      if ((AreaRestringidaDePesca[fila,columna] == 1) && (((nrow(AreaRestringidaDePesca)%*%nrow(AreaRestringidaDePesca))/(nrow(mar) %*% nrow(mar))) > .4)) {
    #      columna <- floor(runif(1,min=1,max=nrow(AreaRestringidaDePesca)+1))
    #      fila <- floor(runif(1,min=1,max=nrow(AreaRestringidaDePesca)+1))
    #      }else{
    Barcos[barco,1] <- columna
    Barcos[barco,2] <- fila
    #        break
    #      }
    #    }
    AreaRestringidaDePesca[fila,columna] <- AreaRestringidaDePesca[fila,columna] + 1
  }
  
  #Generar Numeros Aleatorios Para Coordenadas de YellowFin
  YellowFinx <- floor(runif(NumeroDePeces, min=1, max = nrow(mar)+1))
  YellowFiny <- floor(runif(NumeroDePeces, min=1, max = nrow(mar)+1))
  #Generar Data Frame Para Coordenadas de YellowFin
  YellowFin <- as.data.frame(YellowFinx)
  YellowFin$YellowFiny <- YellowFiny
  #Y ponerlos en el mar
  for (fish in 1:nrow(YellowFin)) {
    row = YellowFin[fish,]
    columna = row$YellowFinx
    fila = row$YellowFiny
    mar[fila,columna] <- mar[fila,columna] + 1
  }
  
  #Se pueden mover los barcos deseado numero de cuadros lateral y horizontal de su antigua posicion
  for (dia in 1:TemporadaDePescaDias) {
    AreaRestringidaDePesca <- matrix(0, nrow =PorcentajeAreaAbierta, ncol = PorcentajeAreaAbierta)
    for (barco in 1:nrow(Barcos)) {
      row = Barcos[barco,]
      columna <- floor(runif(1, min=row$BarcosX-BarcoMovimiento, max = row$BarcosX+BarcoMovimiento))
      fila <- floor(runif(1, min=row$BarcosY-BarcoMovimiento, max = row$BarcosY+BarcoMovimiento))
      if (columna > ncol(AreaRestringidaDePesca)) {
        columna <- ncol(AreaRestringidaDePesca)
      }
      else if (columna < 1) {
        columna <- 1
      }
      if (fila > nrow(AreaRestringidaDePesca)) {
        fila <- nrow(AreaRestringidaDePesca)
      }
      else if (fila < 1) {
        fila <- 1
      }
      #Codigo para que los barcos no puedan estar en las mismas coordenadas, si el %de area abierta es mayor a 40%
      #      repeat{
      #        if ((AreaRestringidaDePesca[fila,columna] == 1) && (((nrow(AreaRestringidaDePesca)%*%nrow(AreaRestringidaDePesca))/(nrow(mar) %*% nrow(mar))) > .4)) {
      #          columna <- floor(runif(1, min=row$BarcosX-BarcoMovimiento, max = row$BarcosX+BarcoMovimiento))
      #          fila <- floor(runif(1, min=row$BarcosY-BarcoMovimiento, max = row$BarcosY+BarcoMovimiento))
      #          if (columna > ncol(AreaRestringidaDePesca)) {
      #            columna <- ncol(AreaRestringidaDePesca)
      #          }
      #          else if (columna < 1) {
      #            columna <- 1
      #          }
      #          if (fila > nrow(AreaRestringidaDePesca)) {
      #            fila <- nrow(AreaRestringidaDePesca)
      #          }
      #          else if (fila < 1) {
      #            fila <- 1
      #          }
      #        } else {
      Barcos[barco,1] <- columna
      Barcos[barco,2] <- fila
      #          break
      #          }
      #      }
      AreaRestringidaDePesca[fila,columna] <- AreaRestringidaDePesca[fila,columna] + 1
    }
    
    if (sum(colSums(mar) != 0)) {
      #Generar Numeros Aleatorios Para Coordenadas de YellowFin. Cada dia se vuelven a mover aleatoriamente los peces
      #Esto ya es solo para los YellowFin que Quedan
      YellowFinx <- floor(runif(sum(colSums(mar)), min=1, max = nrow(mar)+1))
      YellowFiny <- floor(runif(sum(colSums(mar)), min=1, max = nrow(mar)+1))
      #Generar Data Frame Para Coordenadas de YellowFin
      YellowFin <- as.data.frame(YellowFinx)
      YellowFin$YellowFiny <- YellowFiny
      mar <- matrix(0, nrow =MarDimension, ncol = MarDimension)
      #Y ponerlos en el mar
      for (fish in 1:nrow(YellowFin)) {
        row = YellowFin[fish,]
        columna = row$YellowFinx
        fila = row$YellowFiny
        mar[fila,columna] <- mar[fila,columna] + 1
      }
    } else {
      YellowFin <- data.frame (YellowFinx = integer(),YellowFiny = integer())
    }
    #Se va sumando la captura de los barcos
    for (barco in 1:nrow(Barcos)) {
      row = Barcos[barco,]
      columna = row$BarcosX
      fila = row$BarcosY
      Captura <- mar[fila,columna]
      BarcoCapturaPromedio <- append(BarcoCapturaPromedio, Captura)
      mar[fila,columna] <- 0
    }
  }
  #Repeticiones de la Simulacion
  i <- i + 1
  #Si las repeticiones son las pedidas, incrementar Area Abierta y repetir simulacion
  if (i > Repeticiones) {
    tmp <- data.frame(AreaCerrada = ((nrow(AreaRestringidaDePesca)%*%nrow(AreaRestringidaDePesca))/(nrow(mar) %*% nrow(mar))),CapturaPromedio = mean(BarcoCapturaPromedio))
    DatosFinales <- rbind(DatosFinales,tmp)
    AreaAbierta <- AreaAbierta + IncrementoPorcentaje
    AreaCompletaCaptura <- BarcoCapturaPromedio
    BarcoCapturaPromedio <- vector()
    i <- 1
    if (as.double(as.character(AreaAbierta)) > 1) {
      i <- Repeticiones + 1
      DatosFinales$AreaCerrada <- 1-DatosFinales$AreaCerrada
      #Crear folder de acuerdo a longitud del mar y guardar datos finales en folder correspondiente
      folder <- print(paste0("Mar", MarDimension, "x", MarDimension))
      setwd(OriginalWD)
      if (file.exists(folder)){
        setwd(file.path(OriginalWD, folder))
      } else {
        folder <- print(paste0("Mar", MarDimension, "x", MarDimension))
        dir.create(folder)
        setwd(file.path(OriginalWD, folder))
      }
      write.table(DatosFinales, (print(paste0(file.path(OriginalWD, folder),"/TP",TemporadaDePescaDias,"Rep",Repeticiones,
                                              "Mar",MarDimension,"Peces",NumeroDePeces,"Barcos",NumeroDeBarcos,
                                              "Porcen",IncrementoPorcentaje,"MovBarcos",BarcoMovimiento,".txt"))),sep="\t")
      View(Barcos)
      View(YellowFin)
      View(mar)
      View(AreaRestringidaDePesca)
      View(DatosFinales)
      a <- "Arriba estan las capturas de todos los barcos x todos los dias x el numero de repeticiones, con el 100% del area abierta"
      AreaCompletaCaptura
      print(a)
    }
  }
}
#Grafica. Guardarla en el folder creado arriba
plot <- ggplot(data = DatosFinales, aes(x = AreaCerrada, y = CapturaPromedio, group=1))+
  geom_line(color="red")+
  geom_point() + labs(title="Captura de YellowTail Dependiendo de Porcentaje de Area Para Pescar Cerrada", 
                      x ="Porcentaje de Area Cerrada", y ="Captura Promedio")
ranges <- ggplot_build(plot)$layout$panel_ranges[[1]]$y.range

ggplot(data = DatosFinales, aes(x = AreaCerrada, y = CapturaPromedio, group=1))+
  geom_line(color="red")+
  geom_point() + labs(title="Captura de YellowTail Dependiendo de Porcentaje de Area Para Pescar Cerrada", 
                      x ="Porcentaje de Area Cerrada", y ="Captura Promedio") + 
  annotate("rect", xmin = .125, xmax = .5, ymin = as.double(as.character(.008%*%ranges[2])), ymax = as.double(as.character(.5%*%ranges[2])), alpha =.2) +
  annotate("text", x = .19, y = as.double(as.character(.4385%*%ranges[2])), label = print(paste0("Temporada De Pesca Dias = ", TemporadaDePescaDias)), 
           size = 4, hjust = 0) +
  annotate("text", x = .19, y = as.double(as.character(.377%*%ranges[2])), label = print(paste0("Repeticiones = ", Repeticiones)), 
           size = 4, hjust = 0) +
  annotate("text", x = .19, y = as.double(as.character(.3155%*%ranges[2])), label = print(paste0("Mar Dimension = ", MarDimension, "x", MarDimension)),
           size = 4, hjust = 0) +
  annotate("text", x = .19, y = as.double(as.character(.254%*%ranges[2])), label = print(paste0("Numero de Peces = ", NumeroDePeces)),
           size = 4, hjust = 0) +
  annotate("text", x = .19, y = as.double(as.character(.1925%*%ranges[2])), label = print(paste0("Numero de Barcos = ", NumeroDeBarcos)),
           size = 4, hjust = 0) +
  annotate("text", x = .19, y = as.double(as.character(.131%*%ranges[2])), label = print(paste0("Incremento de Porcentaje = ", IncrementoPorcentaje)),
           size = 4, hjust = 0) +
  annotate("text", x = .19, y = as.double(as.character(.0695%*%ranges[2])), label = print(paste0("Movimiento de Barcos en x/y = ", BarcoMovimiento)),
           size = 4, hjust = 0)
ggsave((print(paste0("TP",TemporadaDePescaDias,"Rep",Repeticiones,
                     "Mar",MarDimension,"Peces",NumeroDePeces,"Barcos",NumeroDeBarcos,
                     "Porcen",IncrementoPorcentaje,"MovBarcos",BarcoMovimiento,".pdf"))), width = 26, height = 20, units = "cm")



